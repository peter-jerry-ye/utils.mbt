// Copyright 2024 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

test "rsa" {
  let metadata = "ewogICAgInR5cCI6IkpXVCIsCiAgICAiYWxnIjoiUlMyNTYiCn0"
  @encoding.decode_strict(
    UTF8,
    [metadata].iter() |> @codec.base64_decode(url_safe=true) |> Bytes::from_iter,
  ).to_string!()
  |> inspect!(
    content=
      #|{
      #|    "typ":"JWT",
      #|    "alg":"RS256"
      #|}
    ,
  )
  let payload = "ewogICAgImlhdCI6MTcyNDY2NTI5OSwKICAgICJleHAiOjE3MjQ2NjU5NTksCiAgICAiaXNzIjoiMDEyMzQ1NiIKfQ"
  @encoding.decode_strict(
    UTF8,
    [payload].iter() |> @codec.base64_decode(url_safe=true) |> Bytes::from_iter,
  ).to_string!()
  |> inspect!(
    content=
      #|{
      #|    "iat":1724665299,
      #|    "exp":1724665959,
      #|    "iss":"0123456"
      #|}
    ,
  )
  let expected_crypto = "YboVGRddJwc0xNxJdeXbmqr5yoPEEIMPdPiOldRfLFYY_n4HAfJbcSrhq4kujTfHPbKh2FGpTTPokenpy20PIo_dWDpKCqznyRi4POxzir4jdVYjhLlrDdbukBXz74FIBfXSMb6eXexcj9p9luZEHW5UvpaP8SuLCMdMkWnQxqSbW4_0xHjiv5ArDzQNm555k2Dm1c7SS-CCLBTLqlQVHMlyGl8MbmTu5LC2SZGD2I9CkaV1AG8qhkg5x18V5QCP4Dkt4SItbMHZ4P_b26ERWqtVU6nlxcfc5MYTXkunxo7nNOc9s8bLqj8IyEsypKyQSpaPHx0AUYqUHROn0VxQJg"
  let result = [expected_crypto].iter()
    |> @codec.base64_decode(url_safe=true)
    |> Bytes::from_iter
    |> BigInt::from_octets
  inspect!(
    result,
    content="12336876240073044691363348029232808676135926590206971952196911483742729576836331419031013729995533308920892847804477366807900775106825520014829072227799175150246374808128189555465436634256771610222707804065296574923289612453196593632950519889577844986734552374418264362027558180968325124961932927862989847435381033745147022712443840817991902692892235069349377412037652850557739811522619415437024648105910046624954430726805970890913344467239592315917473170805458886272628321543972071291521099051469975387420351261587741406802643300778392459086794143986805782051435582873966464392943983621144758377947791035112053559334",
  )
  inspect!(
    rsassa_pkcs1_v1_5_sign(
      @encoding.encode(UTF8, "\{metadata}.\{payload}").iter(),
      Pair(
        modulus=22959099950256034890559187556292927784453557983859951626187028542267181746291385208056952622270636003785108992159340113537813968453561739504619062411001131648757071588488220532539782545200321908111599592636973146194058056564924259042296638315976224316360033845852318938823607436658351875086984433074463158236223344828240703648004620467488645622229309082546037826549150096614213390716798147672946512459617730148266423496997160777227482475009932013242738610000405747911162773880928277363924192388244705316312909258695267385559719781821111399096063487484121831441128099512811105145553708218511125708027791532622990325823N,
        exponent=16358669625969388364581104141609389441427641540112063431899987561373091823318469317720180350787335685685177067883371926419606650760753757234961803841251641721018054151029890687512057093407910521097689161508401331075235897422153946629218362494511890545443766734301537836143051602334534677496098769959643127347674117653709560862767683574314126433987860854784002134418813937006574680192217906111795338155415665645853395279769810629758251647311243087303558250016935003936529217269852298186721078356080852876661955868636203495771866307776451235934278538058313992364138792492433515133366470972760378174187477470341640818497N,
        length=2048,
      ),
    ),
    content="12336876240073044691363348029232808676135926590206971952196911483742729576836331419031013729995533308920892847804477366807900775106825520014829072227799175150246374808128189555465436634256771610222707804065296574923289612453196593632950519889577844986734552374418264362027558180968325124961932927862989847435381033745147022712443840817991902692892235069349377412037652850557739811522619415437024648105910046624954430726805970890913344467239592315917473170805458886272628321543972071291521099051469975387420351261587741406802643300778392459086794143986805782051435582873966464392943983621144758377947791035112053559334",
  )
  inspect!(
    rsassa_pkcs1_v1_5_sign(
      @encoding.encode(UTF8, "\{metadata}.\{payload}").iter(),
      Quintuple(
        factor1=158821241699809206379240050294221818859001463459205644463993958696866240205418400547814030766307080042644584970991123482171161583230900837955310531800680184932587150955639915773936331321003111715999458161371827010867661548650955374527536555325452958621842263169220276485047984007097022393251387885340530860307N,
        factor2=144559378232613426908794876466633326578667289294577002125292145506864779092898829854943791512321347393777270116500424839118627337516633149490501210130514723656399948087736749754645662330251897374131452601460606973492794865585239015629328445163471765624481912162148836170882664246068101421643700397030187015589,
        exponent1=81806134795008306448937338873949767905508528037481192916536369741216620696924011585708198980396235729428464147973623378971449739309481965711848537803005340536938591250889369925092218691778721061339300077108026983320256510029606185481881250257431916691296966260331856406392797902369259882646247170994099520139N,
        exponent2=81571484297729178029420683379046447811247005895948122672618960785348221548659408072778374870945507850058397945867253779932648085336567290252959782288425850977880075075645707656385724684301164484073962016183449143029693866429768284129395535813210085364892588822625785593411535567448074502552843193655085616117N,
        coefficient=107767393137383684863285837530603262713505272336046170826402760673649439044164043252947591339783152332586428778090896779512434195821769203110139749156110797117634251017717788024337765459090675461882635600440921636154961089307247094064639739966306348042851661545457199055016518128892220899785968564685096557341N,
        triplets=[],
        length=2048,
      ),
    ),
    content="12336876240073044691363348029232808676135926590206971952196911483742729576836331419031013729995533308920892847804477366807900775106825520014829072227799175150246374808128189555465436634256771610222707804065296574923289612453196593632950519889577844986734552374418264362027558180968325124961932927862989847435381033745147022712443840817991902692892235069349377412037652850557739811522619415437024648105910046624954430726805970890913344467239592315917473170805458886272628321543972071291521099051469975387420351261587741406802643300778392459086794143986805782051435582873966464392943983621144758377947791035112053559334",
  )
  assert_true!(
    rsassa_pkcs1_v1_5_verify(
      @encoding.encode(UTF8, "\{metadata}.\{payload}").iter(),
      22959099950256034890559187556292927784453557983859951626187028542267181746291385208056952622270636003785108992159340113537813968453561739504619062411001131648757071588488220532539782545200321908111599592636973146194058056564924259042296638315976224316360033845852318938823607436658351875086984433074463158236223344828240703648004620467488645622229309082546037826549150096614213390716798147672946512459617730148266423496997160777227482475009932013242738610000405747911162773880928277363924192388244705316312909258695267385559719781821111399096063487484121831441128099512811105145553708218511125708027791532622990325823N,
      65537N,
      12336876240073044691363348029232808676135926590206971952196911483742729576836331419031013729995533308920892847804477366807900775106825520014829072227799175150246374808128189555465436634256771610222707804065296574923289612453196593632950519889577844986734552374418264362027558180968325124961932927862989847435381033745147022712443840817991902692892235069349377412037652850557739811522619415437024648105910046624954430726805970890913344467239592315917473170805458886272628321543972071291521099051469975387420351261587741406802643300778392459086794143986805782051435582873966464392943983621144758377947791035112053559334N,
    ),
  )
  let buffer = @buffer.new()
  [
    12336876240073044691363348029232808676135926590206971952196911483742729576836331419031013729995533308920892847804477366807900775106825520014829072227799175150246374808128189555465436634256771610222707804065296574923289612453196593632950519889577844986734552374418264362027558180968325124961932927862989847435381033745147022712443840817991902692892235069349377412037652850557739811522619415437024648105910046624954430726805970890913344467239592315917473170805458886272628321543972071291521099051469975387420351261587741406802643300778392459086794143986805782051435582873966464392943983621144758377947791035112053559334N
    |> BigInt::to_octets
    |> Bytes::to_fixedarray,
  ].iter()
  |> @codec.base64_encode(url_safe=true)
  |> Iter::filter(fn(ch) { ch != '=' })
  |> Iter::each(fn(ch) { buffer.write_char(ch) })
  inspect!(
    buffer.contents().to_unchecked_string(),
    content="YboVGRddJwc0xNxJdeXbmqr5yoPEEIMPdPiOldRfLFYY_n4HAfJbcSrhq4kujTfHPbKh2FGpTTPokenpy20PIo_dWDpKCqznyRi4POxzir4jdVYjhLlrDdbukBXz74FIBfXSMb6eXexcj9p9luZEHW5UvpaP8SuLCMdMkWnQxqSbW4_0xHjiv5ArDzQNm555k2Dm1c7SS-CCLBTLqlQVHMlyGl8MbmTu5LC2SZGD2I9CkaV1AG8qhkg5x18V5QCP4Dkt4SItbMHZ4P_b26ERWqtVU6nlxcfc5MYTXkunxo7nNOc9s8bLqj8IyEsypKyQSpaPHx0AUYqUHROn0VxQJg",
  )
}
